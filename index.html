<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>í¬ë¥´íˆ¬ê°ˆ 8ì¼ ì—¬í–‰</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#101820;--card:#1a2535;--card2:#1f2f42;--acc:#e8a838;--tx:#eae8e3;--dm:#7a8a9a;--bl:#3b82f6;--gn:#22c55e;--pp:#a855f7;--rd:#ef4444;--or:#f59e0b;--pk:#ec4899;--tl:#14b8a6}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;font-family:'Noto Sans KR',sans-serif;background:var(--bg);color:var(--tx)}
.app{display:flex;flex-direction:column;height:100dvh}
.top{padding:max(env(safe-area-inset-top),8px) 16px 0;background:var(--bg);z-index:50}
.top h1{font-size:17px;font-weight:700;color:var(--acc)}.top p{font-size:11px;color:var(--dm);margin-top:2px}
.mtabs{display:flex;margin:8px 16px 0;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
.mtab{flex:1;padding:9px 0;text-align:center;font-size:13px;font-weight:600;background:0;color:var(--dm);border:none;font-family:inherit;cursor:pointer;transition:.2s}
.mtab.on{background:rgba(232,168,56,.15);color:var(--acc)}
.panel{display:none;flex-direction:column;flex:1;min-height:0;overflow:hidden}.panel.v{display:flex}
.days{display:flex;gap:6px;padding:10px 16px 8px;overflow-x:auto;scrollbar-width:none}.days::-webkit-scrollbar{display:none}
.db{flex-shrink:0;padding:6px 12px;border-radius:20px;border:1px solid rgba(255,255,255,.08);background:0;color:var(--dm);font-size:12px;font-weight:600;font-family:inherit;cursor:pointer;white-space:nowrap}
.db.on{background:var(--acc);color:#000;border-color:var(--acc)}
.db .c{font-size:10px;font-weight:400;opacity:.7}
.vt{display:flex;margin:0 16px 8px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
.vb{flex:1;padding:7px 0;text-align:center;font-size:12px;font-weight:600;background:0;color:var(--dm);border:none;font-family:inherit;cursor:pointer}
.vb.on{background:rgba(232,168,56,.15);color:var(--acc)}
.mw{flex:1;position:relative;display:none;min-height:0}.mw.v{display:flex;flex-direction:column}
#map{width:100%;flex:1;min-height:200px}
#pmap{width:100%;height:100%}
.lw{flex:1;overflow-y:auto;display:none;padding:0 12px 120px;-webkit-overflow-scrolling:touch;min-height:0}.lw.v{display:block}
.ict{display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden}
@media(min-width:768px){.vt{display:none}.ict,.pcontent{flex-direction:row!important}.lw{display:block!important;width:400px;min-width:400px;flex:none!important;border-right:1px solid rgba(255,255,255,.06);padding-bottom:40px}.mw{display:flex!important;flex-direction:column!important;flex:1!important}#pmap{display:block!important;flex:1}}
.dh{padding:12px 4px 8px}.dh h2{font-size:16px;font-weight:700;color:var(--acc)}.dh p{font-size:12px;color:var(--dm);line-height:1.5;margin-top:4px}
/* Stop card */
.st{display:flex;gap:10px;padding:12px 10px;border-radius:10px;cursor:pointer;transition:.15s;position:relative}
.st:active,.st.on{background:var(--card2)}
.sn{width:30px;height:30px;min-width:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff;margin-top:1px}
.sn.sight{background:var(--bl)}.sn.food{background:var(--gn)}.sn.cafe{background:var(--pk)}.sn.lodge{background:var(--or)}.sn.transport-marker{background:var(--pp)}
.si{flex:1;min-width:0}
.nm{font-size:13px;font-weight:600;line-height:1.35}.ne{font-size:11px;color:var(--dm);font-weight:400}
.sm{display:flex;gap:8px;margin-top:3px;font-size:11px;color:var(--dm)}.sm .tm{color:var(--acc);font-weight:600}
.tg{display:flex;gap:4px;margin-top:5px;flex-wrap:wrap}
.tg span{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:500}
.tg .rt{background:rgba(232,168,56,.12);color:var(--acc)}.tg .pr{background:rgba(34,197,94,.12);color:var(--gn)}.tg .cl{background:rgba(239,68,68,.12);color:var(--rd)}.tg .wr{background:rgba(245,158,11,.12);color:var(--or)}
.nt{font-size:11px;color:var(--dm);line-height:1.55;margin-top:6px;display:none}
.st.on .nt{display:block}
.st-actions{display:none;gap:4px;margin-top:6px}
.st.on .st-actions{display:flex}
.sa{padding:4px 8px;border-radius:5px;border:none;font-size:10px;font-family:inherit;cursor:pointer;font-weight:500}
.sa.up{background:rgba(59,130,246,.1);color:var(--bl)}.sa.down{background:rgba(59,130,246,.1);color:var(--bl)}
.sa.del{background:rgba(239,68,68,.1);color:var(--rd)}
/* Transport */
.tl{display:flex;padding:0 0 0 24px;min-height:6px}.tl-b{width:2px;background:rgba(255,255,255,.06)}
.tp{display:flex;align-items:flex-start;gap:8px;padding:4px 0 4px 15px}
.ti{width:22px;height:22px;min-width:22px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:11px}
.ti.walk{background:rgba(59,130,246,.12);color:var(--bl)}.ti.metro{background:rgba(245,158,11,.12);color:var(--or)}.ti.bus{background:rgba(168,85,247,.12);color:var(--pp)}.ti.tram{background:rgba(245,158,11,.12);color:var(--or)}.ti.drive{background:rgba(20,184,166,.12);color:var(--tl)}.ti.transit{background:rgba(168,85,247,.12);color:var(--pp)}
.tt{font-size:11px;color:var(--dm);line-height:1.45}.tt b{color:var(--tx);font-weight:600}
.lgd{position:absolute;bottom:16px;left:12px;right:12px;z-index:5;display:flex;gap:12px;justify-content:center;background:rgba(16,24,32,.9);backdrop-filter:blur(8px);border-radius:10px;padding:8px 16px;border:1px solid rgba(255,255,255,.06)}
.lgd span{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--dm)}.lgd i{width:9px;height:9px;border-radius:50%;display:inline-block}
/* Bottom detail card on map */
.map-card{position:absolute;bottom:0;left:0;right:0;z-index:10;background:var(--card);border-radius:16px 16px 0 0;padding:16px 16px calc(10px + env(safe-area-inset-bottom));transform:translateY(100%);transition:transform .3s ease;box-shadow:0 -4px 20px rgba(0,0,0,.4);border-top:1px solid rgba(255,255,255,.08)}
.map-card.show{transform:translateY(0)}
.mc-handle{width:36px;height:4px;border-radius:2px;background:rgba(255,255,255,.15);margin:0 auto 12px}
.mc-top{display:flex;align-items:flex-start;gap:10px}
.mc-num{width:34px;height:34px;min-width:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff}
.mc-info{flex:1;min-width:0}
.mc-name{font-size:15px;font-weight:700;line-height:1.35}.mc-en{font-size:11px;color:var(--dm)}
.mc-meta{display:flex;gap:6px;margin-top:4px;flex-wrap:wrap}
.mc-meta span{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:500}
.mc-close{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.08);border:none;color:var(--dm);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.mc-note{font-size:12px;color:var(--dm);line-height:1.6;margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,.06)}
.mc-transit{display:flex;align-items:center;gap:6px;margin-top:8px;font-size:11px;color:var(--dm);padding:6px 10px;background:rgba(255,255,255,.03);border-radius:8px}
.mc-transit b{color:var(--tx);font-weight:600}
.mc-nav{display:flex;gap:8px;margin-top:10px}
.mc-nav button{flex:1;padding:8px;border-radius:8px;border:none;font-size:12px;font-weight:600;font-family:inherit;cursor:pointer}
.mc-nav .prev{background:rgba(255,255,255,.06);color:var(--dm)}.mc-nav .next{background:rgba(232,168,56,.15);color:var(--acc)}
.gm-style-iw{max-width:280px!important}
.iw{font-family:'Noto Sans KR',sans-serif;padding:2px}.iw h3{font-size:14px;margin-bottom:3px;color:#222}.iw .sub{font-size:11px;color:#888;margin-bottom:4px}.iw p{font-size:12px;color:#555;line-height:1.5;margin-bottom:2px}
/* Places panel */
.pbar{display:flex;gap:6px;padding:10px 16px 0;flex-wrap:wrap}
.pbtn{padding:5px 12px;border-radius:16px;border:1px solid rgba(255,255,255,.1);background:0;color:var(--dm);font-size:11px;font-weight:500;font-family:inherit;cursor:pointer}
.pbtn.on{border-color:var(--acc);color:var(--acc);background:rgba(232,168,56,.1)}
.pview{display:flex;margin:8px 16px;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
.pvb{flex:1;padding:7px;text-align:center;font-size:12px;font-weight:600;background:0;color:var(--dm);border:none;font-family:inherit;cursor:pointer}.pvb.on{background:rgba(232,168,56,.15);color:var(--acc)}
.pcontent{display:flex;flex:1;overflow:hidden}
.plist{flex:1;overflow-y:auto;padding:8px 12px 120px;-webkit-overflow-scrolling:touch}
#pmap{display:none}
.pcard{background:var(--card);border-radius:12px;padding:14px;margin-bottom:8px}
.pcard.visited{opacity:.5}
.pcard-top{display:flex;align-items:flex-start;gap:10px}
.pcard-icon{width:36px;height:36px;min-width:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px}
.pcard-icon.food{background:rgba(34,197,94,.15)}.pcard-icon.cafe{background:rgba(236,72,153,.15)}.pcard-icon.sight{background:rgba(59,130,246,.15)}.pcard-icon.lodge{background:rgba(245,158,11,.15)}
.pcard-info{flex:1;min-width:0}
.pcard-name{font-size:14px;font-weight:600}.pcard-en{font-size:11px;color:var(--dm)}
.pcard-meta{display:flex;gap:6px;margin-top:4px;flex-wrap:wrap}
.pcard-meta span{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:500}
.pcard-detail{margin-top:8px;font-size:11px;color:var(--dm);line-height:1.6}
.pcard-detail div{margin-bottom:3px}
.pcard-actions{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.pact{padding:5px 10px;border-radius:6px;border:none;font-size:11px;font-family:inherit;cursor:pointer;font-weight:500}
.pact.visit{background:rgba(34,197,94,.15);color:var(--gn)}.pact.visit.done{background:rgba(34,197,94,.3);color:#fff}
.pact.del{background:rgba(239,68,68,.1);color:var(--rd)}
.pact.mapbtn{background:rgba(59,130,246,.1);color:var(--bl)}
.pact.additin{background:rgba(232,168,56,.15);color:var(--acc)}
.add-btn{position:fixed;bottom:calc(24px + env(safe-area-inset-bottom));right:20px;width:52px;height:52px;border-radius:50%;background:var(--acc);color:#000;font-size:24px;border:none;box-shadow:0 4px 16px rgba(0,0,0,.4);cursor:pointer;z-index:100;display:none}
.panel.v .add-btn{display:block}
/* Day add stop btn */
.add-stop{display:flex;align-items:center;justify-content:center;gap:6px;padding:12px;margin:8px 4px;border-radius:10px;border:1px dashed rgba(255,255,255,.1);background:0;color:var(--dm);font-size:12px;font-family:inherit;cursor:pointer;width:calc(100% - 8px)}
.add-stop:active{background:var(--card2)}
/* Modal */
.modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;align-items:flex-end;justify-content:center}.modal-bg.v{display:flex}
.modal{background:var(--card);border-radius:16px 16px 0 0;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;padding:24px 20px calc(20px + env(safe-area-inset-bottom));-webkit-overflow-scrolling:touch}
.modal h2{font-size:17px;font-weight:700;color:var(--acc);margin-bottom:16px}
.mfield{margin-bottom:12px}.mfield label{display:block;font-size:12px;color:var(--dm);margin-bottom:4px;font-weight:500}
.mfield input,.mfield textarea,.mfield select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:var(--bg);color:var(--tx);font-size:13px;font-family:inherit;outline:none}
.mfield textarea{height:60px;resize:none}.mfield select{-webkit-appearance:none}
.mrow{display:flex;gap:8px}.mrow .mfield{flex:1}
.mbtn-row{display:flex;gap:8px;margin-top:16px}
.mbtn{flex:1;padding:12px;border-radius:10px;border:none;font-size:14px;font-weight:600;font-family:inherit;cursor:pointer}
.mbtn.save{background:var(--acc);color:#000}.mbtn.cancel{background:rgba(255,255,255,.08);color:var(--dm)}
/* Day picker modal */
.daypick{display:flex;flex-wrap:wrap;gap:8px;margin:12px 0}
.daypick button{padding:10px 16px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:var(--bg);color:var(--tx);font-size:13px;font-family:inherit;cursor:pointer}
.daypick button:active{background:var(--acc);color:#000}
.empty{text-align:center;padding:60px 20px;color:var(--dm);font-size:13px}
.sync-btn{width:40px;height:40px;border-radius:50%;border:1px solid rgba(255,255,255,.1);background:var(--card);color:var(--acc);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.3s;flex-shrink:0}
.sync-btn.spinning{animation:spin 1s linear infinite}
.day-badge{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;padding:0 6px;border-radius:11px;font-size:10px;font-weight:700;cursor:pointer;transition:.2s}
.day-badge.set{background:var(--acc);color:#1a2636}.day-badge.unset{background:rgba(255,255,255,.08);color:var(--dm);border:1px dashed rgba(255,255,255,.15)}
.day-pick-row{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
.day-pick-row button{width:28px;height:28px;border-radius:14px;border:1px solid rgba(255,255,255,.1);background:var(--card2);color:var(--tx);font-size:11px;font-weight:700;cursor:pointer;transition:.2s}
.day-pick-row button.active{background:var(--acc);color:#1a2636;border-color:var(--acc)}
.day-pick-row button:hover{background:var(--acc);color:#1a2636}
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.sync-status{font-size:10px;color:var(--dm);margin-top:4px;min-height:14px;transition:opacity .3s}
.sync-status.ok{color:var(--gn)}.sync-status.err{color:var(--rd)}.sync-status.warn{color:var(--or)}
/* Google Places Autocomplete */
.pac-container{background:var(--card)!important;border:1px solid rgba(255,255,255,.1)!important;border-radius:10px!important;margin-top:4px!important;font-family:'Noto Sans KR',sans-serif!important;z-index:10000!important;box-shadow:0 8px 24px rgba(0,0,0,.5)!important;pointer-events:auto!important}
.pac-item{padding:12px 14px!important;border-top:1px solid rgba(255,255,255,.06)!important;color:var(--tx)!important;font-size:13px!important;cursor:pointer!important;-webkit-tap-highlight-color:rgba(232,168,56,.2)!important}
.pac-item:first-child{border-top:none!important}
.pac-item:hover,.pac-item-selected{background:var(--card2)!important}
.pac-item-query{color:var(--acc)!important;font-weight:600!important}
.pac-icon{display:none!important}
.pac-matched{color:var(--acc)!important}
</style>
</head>
<body>
<div class="app">
<div class="top">
<div style="display:flex;align-items:center;justify-content:space-between">
<div><h1>ğŸ‡µğŸ‡¹ í¬ë¥´íˆ¬ê°ˆ 8ì¼ ì—¬í–‰</h1><p>í¬ë¥´íˆ¬ 3ì¼ + ë¦¬ìŠ¤ë³¸ 5ì¼</p></div>
<div style="display:flex;gap:6px">
<button class="sync-btn" onclick="openExport()" title="ë‚´ë³´ë‚´ê¸°">ğŸ“¤</button>
<button class="sync-btn" id="syncBtn" onclick="syncData()" title="ë™ê¸°í™”">ğŸ”„</button>
</div></div>
<div class="sync-status" id="syncStatus"></div>
</div>
<div class="mtabs">
<button class="mtab on" onclick="mainTab('itin')" id="mt1">ğŸ“… ì¼ì •</button>
<button class="mtab" onclick="mainTab('places')" id="mt2">ğŸ“ ì €ì¥ì†Œ</button>
</div>
<!-- ITINERARY -->
<div class="panel v" id="itinPanel">
<div class="days" id="dy"></div>
<div class="vt"><button class="vb" onclick="itinView('map')" id="iv1">ğŸ—º ì§€ë„</button><button class="vb on" onclick="itinView('list')" id="iv2">ğŸ“‹ ì¼ì •</button></div>
<div class="ict">
<div class="lw v" id="lw"><div id="ls"></div></div>
<div class="mw" id="mw"><div id="map"></div>
<div class="lgd" id="mapLgd"><span><i style="background:var(--bl)"></i>ê´€ê´‘</span><span><i style="background:var(--gn)"></i>ë§›ì§‘</span><span><i style="background:var(--or)"></i>ìˆ™ì†Œ</span><span><i style="background:var(--pp)"></i>êµí†µ</span></div>
<div class="map-card" id="mapCard">
<div class="mc-handle"></div>
<div class="mc-top">
<div class="mc-num" id="mcNum">1</div>
<div class="mc-info"><div class="mc-name" id="mcName"></div><div class="mc-en" id="mcEn"></div>
<div class="mc-meta" id="mcMeta"></div></div>
<button class="mc-close" onclick="closeMapCard()">âœ•</button>
</div>
<div class="mc-note" id="mcNote"></div>
<div class="mc-transit" id="mcTransit" style="display:none"></div>
<div class="mc-nav"><button class="prev" onclick="navCard(-1)">â† ì´ì „</button><button class="next" onclick="navCard(1)">ë‹¤ìŒ â†’</button></div>
</div>
</div></div></div>
<!-- PLACES -->
<div class="panel" id="placesPanel">
<div class="pbar" id="pbar">
<button class="pbtn on" onclick="pf('all',this)">ì „ì²´</button>
<button class="pbtn" onclick="pf('food',this)">ğŸ½ï¸ ë§›ì§‘</button>
<button class="pbtn" onclick="pf('cafe',this)">â˜• ì¹´í˜</button>
<button class="pbtn" onclick="pf('sight',this)">ğŸ›ï¸ ê´€ê´‘ì§€</button>
<button class="pbtn" onclick="pf('lodge',this)">ğŸ¨ ìˆ™ì†Œ</button>
<button class="pbtn" onclick="pf('porto',this)">í¬ë¥´íˆ¬</button>
<button class="pbtn" onclick="pf('lisbon',this)">ë¦¬ìŠ¤ë³¸</button>
<button class="pbtn" onclick="pf('visited',this)">âœ… ë°©ë¬¸</button>
</div>
<div class="pbar" id="pbar2" style="margin-top:-4px">
<button class="pbtn" onclick="pf('d1',this)">D1</button>
<button class="pbtn" onclick="pf('d2',this)">D2</button>
<button class="pbtn" onclick="pf('d3',this)">D3</button>
<button class="pbtn" onclick="pf('d4',this)">D4</button>
<button class="pbtn" onclick="pf('d5',this)">D5</button>
<button class="pbtn" onclick="pf('d6',this)">D6</button>
<button class="pbtn" onclick="pf('d7',this)">D7</button>
<button class="pbtn" onclick="pf('d8',this)">D8</button>
<button class="pbtn" onclick="pf('noday',this)">ë¯¸ì •</button>
<button class="pbtn" onclick="toggleSort()" id="sortBtn" style="margin-left:auto">ğŸ“… ì¼ì°¨ìˆœ</button>
</div>
<div class="pview"><button class="pvb on" onclick="placeView('list')" id="pv1">ğŸ“‹ ëª©ë¡</button><button class="pvb" onclick="placeView('map')" id="pv2">ğŸ—º ì§€ë„</button></div>
<div class="pcontent">
<div class="plist" id="plist"></div>
<div id="pmap"></div>
</div>
<button class="add-btn" onclick="openAdd()">+</button>
</div>
<!-- ADD/EDIT MODAL -->
<div class="modal-bg" id="modal"><div class="modal">
<h2 id="modalTitle">ìƒˆ ì¥ì†Œ ì¶”ê°€</h2>
<div class="mfield"><label>ğŸ” ì¥ì†Œ ê²€ìƒ‰ (ì˜ë¬¸)</label><input id="fNameEn" placeholder="ì˜ˆ: PastÃ©is de BelÃ©m" autocomplete="off" style="font-size:15px;padding:12px"><div id="acHint" style="font-size:10px;color:var(--acc);margin-top:3px">ğŸ“ ê²€ìƒ‰ í›„ ì„ íƒí•˜ë©´ ì¢Œí‘œÂ·í‰ì Â·ì¹´í…Œê³ ë¦¬ ìë™ ì…ë ¥</div></div>
<div class="mrow"><div class="mfield"><label>ì¹´í…Œê³ ë¦¬</label><select id="fCat"><option value="food">ğŸ½ï¸ ë§›ì§‘</option><option value="cafe">â˜• ì¹´í˜</option><option value="sight">ğŸ›ï¸ ê´€ê´‘ì§€</option><option value="lodge">ğŸ¨ ìˆ™ì†Œ</option></select></div>
<div class="mfield"><label>ë„ì‹œ</label><select id="fCity"><option value="porto">í¬ë¥´íˆ¬</option><option value="lisbon">ë¦¬ìŠ¤ë³¸</option><option value="sintra">ì‹ íŠ¸ë¼</option></select></div></div>
<div class="mfield"><label>ì´ë¦„ (í•œê¸€)</label><input id="fName" placeholder="ì˜ˆ: íŒŒìŠ¤í…Œì´ìŠ¤ ë“œ ë²¨ë "></div>
<div class="mrow"><div class="mfield"><label>í‰ì </label><input id="fRating" type="number" step="0.1" min="0" max="5" placeholder="4.8"></div>
<div class="mfield"><label>ê°€ê²©ëŒ€</label><select id="fPrice"><option value="">ì„ íƒ</option><option value="â‚¬">â‚¬</option><option value="â‚¬â‚¬">â‚¬â‚¬</option><option value="â‚¬â‚¬â‚¬">â‚¬â‚¬â‚¬</option><option value="ë¬´ë£Œ">ë¬´ë£Œ</option></select></div></div>
<div class="mrow"><div class="mfield"><label>ì˜ì—…ì‹œê°„</label><input id="fHours" placeholder="10:00~22:00"></div>
<div class="mfield"><label>íœ´ë¬´ì¼</label><input id="fClosed" placeholder="ì›”,ì¼"></div></div>
<div class="mfield"><label>ì¶”ì²œë©”ë‰´/í•˜ì´ë¼ì´íŠ¸</label><input id="fMenu" placeholder="í”„ë€ì„¸ì§€ëƒ, ëŒ€êµ¬ìš”ë¦¬"></div>
<div class="mfield"><label>í•œì¤„íŒ</label><textarea id="fTip" placeholder="ì˜ˆì•½ í•„ìˆ˜! 18ì‹œ ì˜¤í”ˆ."></textarea></div>
<div class="mrow"><div class="mfield"><label>ìœ„ë„</label><input id="fLat" type="number" step="any" placeholder="38.697"></div>
<div class="mfield"><label>ê²½ë„</label><input id="fLng" type="number" step="any" placeholder="-9.203"></div></div>
<p style="font-size:10px;color:var(--dm);margin-top:-4px">ğŸ’¡ Google Mapsì—ì„œ ì¥ì†Œ ê¸¸ê²Œ ëˆ„ë¥´ë©´ ì¢Œí‘œ ë³µì‚¬ ê°€ëŠ¥</p>
<div class="mbtn-row"><button class="mbtn cancel" onclick="closeModal()">ì·¨ì†Œ</button><button class="mbtn save" onclick="savePlace()">ì €ì¥</button></div>
</div></div>
<!-- DAY PICKER MODAL -->
<div class="modal-bg" id="dayModal"><div class="modal">
<h2>ì–´ëŠ ë‚ ì— ì¶”ê°€í• ê¹Œìš”?</h2>
<div class="daypick" id="dayPick"></div>
<div class="mbtn-row"><button class="mbtn cancel" onclick="closeDayModal()">ì·¨ì†Œ</button></div>
</div></div>
<!-- EXPORT MODAL -->
<div class="modal-bg" id="exportModal"><div class="modal">
<h2>ğŸ“¤ Google Mapsì—ì„œ ì—´ê¸°</h2>
<p style="font-size:12px;color:var(--dm);margin-bottom:12px">íƒ­í•˜ë©´ Google Maps ì•±ì—ì„œ ë°”ë¡œ ì—´ë ¤ìš”.</p>
<div style="display:flex;flex-direction:column;gap:6px">
<button class="mbtn save" onclick="openInGmaps('day')" style="text-align:left;padding:12px">ğŸ“… í˜„ì¬ ì¼ì • (Day <span id="expDay">1</span>) â€” ë„ë³´ ê²½ë¡œ</button>
<div style="font-size:11px;color:var(--dm);margin:6px 0 2px;font-weight:600">ğŸ“ ì €ì¥ì†Œ ì¹´í…Œê³ ë¦¬ë³„</div>
<button class="mbtn save" onclick="openInGmaps('food')" style="text-align:left;padding:12px">ğŸ½ï¸ ë§›ì§‘ <span id="expFood" style="font-size:11px;opacity:.6"></span></button>
<button class="mbtn save" onclick="openInGmaps('cafe')" style="text-align:left;padding:12px">â˜• ì¹´í˜ <span id="expCafe" style="font-size:11px;opacity:.6"></span></button>
<button class="mbtn save" onclick="openInGmaps('sight')" style="text-align:left;padding:12px">ğŸ›ï¸ ê´€ê´‘ì§€ <span id="expSight" style="font-size:11px;opacity:.6"></span></button>
<button class="mbtn save" onclick="openInGmaps('lodge')" style="text-align:left;padding:12px">ğŸ¨ ìˆ™ì†Œ <span id="expLodge" style="font-size:11px;opacity:.6"></span></button>
</div>
<p style="font-size:10px;color:var(--dm);margin-top:10px">ğŸ’¡ ì•± ì„¤ì¹˜ ì‹œ ì•±ìœ¼ë¡œ, ë¯¸ì„¤ì¹˜ ì‹œ ì›¹ìœ¼ë¡œ ì—´ë ¤ìš”.</p>
<div class="mbtn-row" style="margin-top:8px"><button class="mbtn cancel" onclick="closeExport()">ë‹«ê¸°</button></div>
</div></div>
</div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import{getFirestore,collection,addDoc,getDocs,deleteDoc,doc,updateDoc,setDoc}from"https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
import{getAuth,signInAnonymously}from"https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

const app=initializeApp({apiKey:"AIzaSyC5M014PkaOMBGHrWVQP6Q_wb6zOb7I0qs",authDomain:"gosuchatapp.firebaseapp.com",projectId:"gosuchatapp",storageBucket:"gosuchatapp.firebasestorage.app",messagingSenderId:"629416132349",appId:"1:629416132349:web:52c704d8740b1d59464894"});
const db=getFirestore(app);
const auth=getAuth(app);
signInAnonymously(auth).catch(e=>console.log(e));

window.FB={db,collection,addDoc,getDocs,deleteDoc,doc,updateDoc,setDoc};
window.PCOL='portugalPlaces';
window.ICOL='portugalItinerary';
const LS_PLACES='pt_places';
const LS_DAYS='pt_days';
const LS_LASTMOD='pt_lastmod';

// ===== SEED DATA =====
const SEED_PLACES=[
{id:'s1',cat:"food",city:"porto",name:"VOLTARIA",nameEn:"Petisqueira Voltaria",rating:4.8,price:"â‚¬",closed:"ìˆ˜,ì¼",menu:"í”„ë€ì„¸ì§€ëƒ, ëŒ€êµ¬ìš”ë¦¬",tip:"ê°€ì •ì‹ ìš”ë¦¬!",lat:41.1444161,lng:-8.6122994,visited:false,day:1},
{id:'s2',cat:"food",city:"porto",name:"The Door",nameEn:"The Door Porto",rating:4.8,price:"â‚¬â‚¬",menu:"í…Œì´ìŠ¤íŒ… ì½”ìŠ¤",tip:"ì˜ˆì•½ í•„ìˆ˜ (18ì‹œ ì˜¤í”ˆ).",lat:41.1441961,lng:-8.616688,visited:false,day:1},
{id:'s3',cat:"food",city:"porto",name:"Bota & Bira",nameEn:"Bota & Bira",rating:4.8,price:"â‚¬â‚¬",closed:"ì›”,ì¼",menu:"ë¦½ì•„ì´, ë¬¸ì–´",tip:"ìŠ¤í…Œì´í¬ ì „ë¬¸.",lat:41.1424129,lng:-8.6158059,visited:false,day:2},
{id:'s4',cat:"food",city:"porto",name:"Taberna Dos Mercadores",nameEn:"Taberna Dos Mercadores",rating:4.5,price:"â‚¬â‚¬",closed:"ì›”",menu:"ë¬¸ì–´ë°¥",tip:"16ì„ë¿!",lat:41.1413291,lng:-8.6129202,visited:false,day:2},
{id:'s5',cat:"food",city:"porto",name:"BrasÃ£o Aliados",nameEn:"BrasÃ£o Aliados",rating:4.6,price:"â‚¬â‚¬",menu:"í”„ë€ì„¸ì§€ëƒ",tip:"3/4 ì‚¬ì´ì¦ˆ 1ì¸ ì¶©ë¶„.",lat:41.1491541,lng:-8.6117884,visited:false,day:3},
{id:'s6',cat:"food",city:"porto",name:"A Despensa",nameEn:"A Despensa",rating:4.8,price:"â‚¬â‚¬",closed:"ì›”",menu:"íŒŒìŠ¤íƒ€, ë¼ìëƒ",tip:"ë¯¸ì‰ë¦°ê¸‰.",lat:41.147249,lng:-8.613547,visited:false,day:3},
{id:'s7',cat:"food",city:"lisbon",name:"Taberna Sal Grosso",nameEn:"Taberna Sal Grosso",rating:4.7,price:"â‚¬",menu:"ë¬¸ì–´+ê³ êµ¬ë§ˆë§¤ì‹œ",tip:"ì•ŒíŒŒë§ˆ ìˆ¨ì€ ë§›ì§‘!",lat:38.7136987,lng:-9.1244447,visited:false,day:4},
{id:'s8',cat:"food",city:"lisbon",name:"A Nossa Casa",nameEn:"A Nossa Casa",rating:4.8,price:"â‚¬â‚¬",menu:"íƒ€ë¥´íƒ€ë¥´, ë¬¸ì–´",tip:"24ì„. ì˜ˆì•½!",lat:38.7118452,lng:-9.1449444,visited:false,day:4},
{id:'s9',cat:"food",city:"lisbon",name:"íŒŒìŠ¤í…Œì´ìŠ¤ ë“œ ë²¨ë ",nameEn:"PastÃ©is de BelÃ©m",rating:4.6,price:"â‚¬",menu:"ì—ê·¸íƒ€ë¥´íŠ¸",tip:"ì•„ì¹¨ì— ì¤„ ì§§ì•„ìš”!",lat:38.6975105,lng:-9.203228,visited:false,day:5},
{id:'s10',cat:"food",city:"lisbon",name:"Time Out Market",nameEn:"Time Out Market",rating:4.4,price:"â‚¬â‚¬~â‚¬â‚¬â‚¬",menu:"ë‹¤ì–‘í•œ ìŒì‹",tip:"í•œê³³ì—ì„œ ë‹¤ì–‘í•˜ê²Œ.",lat:38.7070608,lng:-9.1456691,visited:false,day:5},
{id:'s11',cat:"food",city:"lisbon",name:"Lisbon Tu e Eu",nameEn:"Lisboa Tu & Eu",rating:4.5,price:"â‚¬",menu:"ì˜¤ì§•ì–´+ê°ì",tip:"ê°€ì„±ë¹„ ë¡œì»¬.",lat:38.710951,lng:-9.130052,visited:false,day:7},
{id:'s12',cat:"food",city:"lisbon",name:"Cervejaria Ramiro",nameEn:"Cervejaria Ramiro",rating:4.4,price:"â‚¬â‚¬â‚¬",closed:"ì›”",menu:"íƒ€ì´ê±°ìƒˆìš°, ë§ˆëŠ˜ê²Œ",tip:"ë²ˆí˜¸í‘œ ëŒ€ê¸°.",lat:38.720257,lng:-9.135743,visited:false,day:7},
{id:'s13',cat:"food",city:"lisbon",name:"Augusto Lisboa",nameEn:"Augusto Lisboa",rating:4.8,price:"â‚¬â‚¬",menu:"ìŠ¤í¬ë¨ë¸”ì—ê·¸",tip:"ë¸ŒëŸ°ì¹˜ ë§›ì§‘.",lat:38.714425,lng:-9.130207,visited:false,day:8},
{id:'s14',cat:"food",city:"lisbon",name:"Copo de Mar",nameEn:"Copo de Mar",rating:4.8,price:"â‚¬â‚¬",closed:"ì¼",menu:"ëŒ€êµ¬, ë¬¸ì–´",tip:"í”¼ë‚ ë ˆ ë””ë„ˆ!",lat:38.739801,lng:-9.149103,visited:false,day:8},
{id:'s15',cat:"sight",city:"porto",name:"ìƒë²¤íˆ¬ ê¸°ì°¨ì—­",nameEn:"EstaÃ§Ã£o SÃ£o Bento",rating:4.7,price:"ë¬´ë£Œ",menu:"ì•„ì¤„ë ˆì£¼ íƒ€ì¼",tip:"2ë§Œ ê°œ í‘¸ë¥¸ íƒ€ì¼.",lat:41.145492,lng:-8.609544,visited:false,day:1},
{id:'s16',cat:"sight",city:"porto",name:"í´ë ˆë¦¬êµ¬ìŠ¤ íƒ‘",nameEn:"Torre dos ClÃ©rigos",rating:4.6,price:"â‚¬10",menu:"240ê³„ë‹¨ ì „ë§ëŒ€",tip:"í¬ë¥´íˆ¬ ìµœê³  ì „ë§!",lat:41.1456705,lng:-8.6145977,visited:false,day:1},
{id:'s17',cat:"sight",city:"porto",name:"ë¦¬ë¸Œë¼ë¦¬ì•„ ë ë£¨",nameEn:"Livraria Lello",rating:4.0,price:"â‚¬8",menu:"ì•„ë¦„ë‹¤ìš´ ì„œì ",tip:"ì‚¬ì „ ì˜ˆì•½ í•„ìˆ˜!",lat:41.146905,lng:-8.614774,visited:false,day:1},
{id:'s18',cat:"sight",city:"porto",name:"ë¦¬ë² ì´ë¼ ì§€êµ¬",nameEn:"Cais da Ribeira",rating:4.8,price:"ë¬´ë£Œ",menu:"UNESCO ìœ ì‚°",tip:"ë„ìš°ë¡œ ê°•ë³€.",lat:41.14041,lng:-8.612566,visited:false,day:1},
{id:'s19',cat:"sight",city:"porto",name:"ë” ë£¨ì´ìŠ¤ ë‹¤ë¦¬",nameEn:"Ponte Dom LuÃ­s I",rating:4.8,price:"ë¬´ë£Œ",menu:"íŒŒë…¸ë¼ë§ˆ ë·°",tip:"ìƒì¸µìœ¼ë¡œ!",lat:41.139959,lng:-8.609449,visited:false,day:2},
{id:'s20',cat:"sight",city:"lisbon",name:"ìƒ ì¡°ë¥´ì œ ì„±",nameEn:"Castelo de SÃ£o Jorge",rating:4.5,price:"â‚¬15",menu:"íŒŒë…¸ë¼ë§ˆ ë·°",tip:"Lisboa Card ë¬´ë£Œ.",lat:38.713909,lng:-9.133476,visited:false,day:4},
{id:'s21',cat:"sight",city:"lisbon",name:"ì œë¡œë‹ˆë¬´ìŠ¤ ìˆ˜ë„ì›",nameEn:"Mosteiro dos JerÃ³nimos",rating:4.5,price:"â‚¬10",closed:"ì›”",menu:"ë§ˆëˆ„ì—˜ ì–‘ì‹",tip:"ì˜¨ë¼ì¸ ì˜ˆì•½!",lat:38.6978909,lng:-9.206704,visited:false,day:5},
{id:'s22',cat:"sight",city:"lisbon",name:"ì˜¤ì„¸ì•„ë‚˜ë¦¬ì›€",nameEn:"OceanÃ¡rio de Lisboa",rating:4.7,price:"â‚¬25~29",menu:"í•´ë‹¬, í•´íŒŒë¦¬",tip:"ìœ ëŸ½ ìµœëŒ€!",lat:38.7635435,lng:-9.0937415,visited:false,day:8},
{id:'s23',cat:"sight",city:"sintra",name:"í˜ë‚˜ ê¶ì „",nameEn:"PalÃ¡cio da Pena",rating:4.4,price:"â‚¬14~20",menu:"ë™í™” ì† ê¶ì „",tip:"ì˜ˆì•½ í•„ìˆ˜!",lat:38.7875851,lng:-9.3906089,visited:false,day:6},
{id:'c1',cat:"cafe",city:"porto",name:"ë…¸ì‹œ ì»¤í”¼",nameEn:"Noshi Coffee",rating:4.5,price:"â‚¬â‚¬",hours:"8:00~18:00",menu:"ë¸ŒëŸ°ì¹˜, ì•„ì‚¬ì´ë³¼",tip:"í´ë ˆë¦¬êµ¬ìŠ¤ íƒ‘ ì˜†! ìˆ¨ì€ ì •ì› í…Œë¼ìŠ¤.",lat:41.147068,lng:-8.6168155,visited:false,day:1},
{id:'c2',cat:"cafe",city:"porto",name:"ë§ˆì´ ì»¤í”¼ í¬ë¥´íˆ¬",nameEn:"My Coffee Porto",rating:4.5,price:"â‚¬",hours:"9:00~18:00",menu:"í”Œë«í™”ì´íŠ¸, ì•„ì‚¬ì´ë³¼",tip:"ë¦¬ë² ì´ë¼ ê³„ë‹¨ ì¤‘ê°„. ë„ìš°ë¡œê°• ë·°!",lat:41.1411563,lng:-8.610052,visited:false,day:1},
{id:'c3',cat:"cafe",city:"porto",name:"7g ë¡œìŠ¤í„°",nameEn:"7g Roaster",rating:4.6,price:"â‚¬â‚¬",hours:"8:30~18:00",menu:"ì—ê·¸ ë² ë„¤ë”•íŠ¸, íŒ¬ì¼€ì´í¬",tip:"ê°€ì´ì•„ ì…€ëŸ¬ ê·¼ì²˜. ìì²´ ë¡œìŠ¤íŒ…!",lat:41.13695,lng:-8.61402,visited:false,day:2},
{id:'c4',cat:"cafe",city:"porto",name:"ë ˆì´íƒ€ë¦¬ì•„ ë‹¤ í‚¨íƒ€",nameEn:"Leitaria da Quinta do PaÃ§o",rating:4.2,price:"â‚¬â‚¬",hours:"9:00~20:00",menu:"ì—í´ë ˆì–´, ìƒ¹í‹¸ë¦¬ í¬ë£¨ì•„ìƒ",tip:"1920ë…„ëŒ€ë¶€í„° ìœ ëª…í•œ ì—í´ë ˆì–´!",lat:41.1477236,lng:-8.6149306,visited:false,day:3},
{id:'c5',cat:"cafe",city:"lisbon",name:"ì½”íœí•˜ê² ì»¤í”¼ë©",nameEn:"Copenhagen Coffee Lab Alfama",rating:4.3,price:"â‚¬â‚¬",hours:"7:30~18:00",menu:"ì‹œë‚˜ëª¬ë²ˆ, ì‚¬ì›Œë„ìš°ë¹µ",tip:"ì•ŒíŒŒë§ˆ í…Œë¼ìŠ¤. ëŒ€ì„±ë‹¹ ë„ë³´ 3ë¶„!",lat:38.7135217,lng:-9.1286418,visited:false,day:4},
{id:'c6',cat:"cafe",city:"lisbon",name:"ë” í¬í¬ìŠ¤ ì„¸",nameEn:"The Folks SÃ©",rating:4.8,price:"â‚¬â‚¬",hours:"8:30~16:00",menu:"ì—ê·¸ ë² ë„¤ë”•íŠ¸, ì‹œë¥´ë‹ˆí‚¤, íŒ¬ì¼€ì´í¬",tip:"ë¦¬ìŠ¤ë³¸ ìµœê³  ë¸ŒëŸ°ì¹˜! ëŒ€ì„±ë‹¹ ì˜†.",lat:38.7104984,lng:-9.1343326,visited:false,day:4},
{id:'c7',cat:"cafe",city:"lisbon",name:"íŒŒë¸Œë¦¬ì¹´ ë‹¤ ë‚˜íƒ€",nameEn:"FÃ¡brica da Nata",rating:4.6,price:"â‚¬",hours:"8:00~23:00",menu:"ë‚˜íƒ€(ì—ê·¸íƒ€ë¥´íŠ¸)",tip:"ë²¨ë ë³´ë‹¤ ë§›ìˆë‹¤ëŠ” í‰ê°€ë„! ë°”ì´ìƒ¤.",lat:38.7126534,lng:-9.1385487,visited:false,day:7},
{id:'c8',cat:"cafe",city:"lisbon",name:"ì½°ì§€ ì¹´í˜",nameEn:"Quase CafÃ©",rating:4.7,price:"â‚¬â‚¬",hours:"8:30~16:00",menu:"í„°í‚¤ì—ê·¸, ì•„ì‚¬ì´ë³¼, ë¸ŒëŸ°ì¹˜",tip:"ì•ŒíŒŒë§ˆ ëŒ€í˜• ë¸ŒëŸ°ì¹˜. ë„‰ë„‰í•œ ì–‘!",lat:38.7138059,lng:-9.1303937,visited:false,day:8}
];

const SEED_ITIN=[
{day:1,title:"í¬ë¥´íˆ¬ Day 1",sub:"êµ¬ì‹œê°€ì§€",city:"porto",stops:[{order:0,cat:"sight",name:"ìƒë²¤íˆ¬ ê¸°ì°¨ì—­",nameEn:"EstaÃ§Ã£o SÃ£o Bento",lat:41.145492,lng:-8.609544,tm:"10:00",dur:"30ë¶„",note:"ì•„ì¤„ë ˆì£¼ íƒ€ì¼!"},{order:1,cat:"sight",name:"í¬ë¥´íˆ¬ ëŒ€ì„±ë‹¹",nameEn:"SÃ© do Porto",lat:41.142853,lng:-8.611116,tm:"10:45",dur:"45ë¶„",note:"360ë„ ì „ë§."},{order:2,cat:"sight",name:"ë¦¬ë² ì´ë¼ ì§€êµ¬",nameEn:"Cais da Ribeira",lat:41.14041,lng:-8.612566,tm:"11:45",dur:"45ë¶„",note:"UNESCO ìœ ì‚°."},{order:3,cat:"food",name:"ğŸ½ï¸ VOLTARIA",nameEn:"Voltaria",lat:41.1444161,lng:-8.6122994,tm:"12:45",dur:"75ë¶„",note:"í”„ë€ì„¸ì§€ëƒ ì¶”ì²œ."},{order:4,cat:"sight",name:"í´ë ˆë¦¬êµ¬ìŠ¤ íƒ‘",nameEn:"Torre dos ClÃ©rigos",lat:41.1456705,lng:-8.6145977,tm:"14:30",dur:"60ë¶„",note:"240ê³„ë‹¨!"},{order:5,cat:"sight",name:"ë¦¬ë¸Œë¼ë¦¬ì•„ ë ë£¨",nameEn:"Livraria Lello",lat:41.146905,lng:-8.614774,tm:"15:45",dur:"30ë¶„",note:"ì‚¬ì „ ì˜ˆì•½!"},{order:6,cat:"food",name:"ğŸ½ï¸ The Door",nameEn:"The Door Porto",lat:41.1441961,lng:-8.616688,tm:"18:30",dur:"90ë¶„",note:"í…Œì´ìŠ¤íŒ… ì½”ìŠ¤."}]},
{day:2,title:"í¬ë¥´íˆ¬ Day 2",sub:"ì™€ì¸ & ê°€ì´ì•„",city:"porto",stops:[{order:0,cat:"sight",name:"ë” ë£¨ì´ìŠ¤ ë‹¤ë¦¬",nameEn:"Ponte Dom LuÃ­s I",lat:41.139959,lng:-8.609449,tm:"10:00",dur:"30ë¶„",note:"ìƒì¸µ!"},{order:1,cat:"sight",name:"Fonseca ì…€ëŸ¬",nameEn:"Fonseca",lat:41.1354472,lng:-8.614342,tm:"10:45",dur:"75ë¶„",note:"í† ë‹ˆ í¬íŠ¸."},{order:2,cat:"sight",name:"Niepoort ì…€ëŸ¬",nameEn:"Niepoort",lat:41.1342013,lng:-8.618324,tm:"12:15",dur:"75ë¶„",note:"ì˜ˆì•½!"},{order:3,cat:"food",name:"ğŸ½ï¸ Taberna Mercadores",nameEn:"Taberna Dos Mercadores",lat:41.1413291,lng:-8.6129202,tm:"13:45",dur:"75ë¶„",note:"ë¬¸ì–´ë°¥!"},{order:4,cat:"sight",name:"í¬ë¦¬ìŠ¤íƒˆ ê¶ì „ ì •ì›",nameEn:"Jardins PalÃ¡cio de Cristal",lat:41.1482682,lng:-8.6255165,tm:"15:30",dur:"90ë¶„",note:"ì¼ëª°!"},{order:5,cat:"food",name:"ğŸ½ï¸ Bota & Bira",nameEn:"Bota & Bira",lat:41.1424129,lng:-8.6158059,tm:"19:00",dur:"90ë¶„",note:"ë¦½ì•„ì´!"}]},
{day:3,title:"í¬ë¥´íˆ¬ Day 3",sub:"ë³¼ì‚¬ ê¶ì „",city:"porto",stops:[{order:0,cat:"sight",name:"ë³¼ì‚¬ ê¶ì „",nameEn:"PalÃ¡cio da Bolsa",lat:41.1413772,lng:-8.615672,tm:"10:00",dur:"60ë¶„",note:"ì•„ëì˜ ë°©!"},{order:1,cat:"sight",name:"ë¹„ë¥´íˆ¬ë°ìŠ¤ ê³µì›",nameEn:"Parque das Virtudes",lat:41.1447,lng:-8.618988,tm:"11:30",dur:"45ë¶„",note:"ìˆ¨ì€ ëª…ì†Œ."},{order:2,cat:"food",name:"ğŸ½ï¸ BrasÃ£o Aliados",nameEn:"BrasÃ£o Aliados",lat:41.1491541,lng:-8.6117884,tm:"12:45",dur:"75ë¶„",note:"í”„ë€ì„¸ì§€ëƒ!"},{order:3,cat:"food",name:"ğŸ½ï¸ A Despensa",nameEn:"A Despensa",lat:41.147249,lng:-8.613547,tm:"19:30",dur:"90ë¶„",note:"ìµœê³  íŒŒìŠ¤íƒ€!"}]},
{day:4,title:"ë¦¬ìŠ¤ë³¸ Day 1",sub:"ì•ŒíŒŒë§ˆ & ì„±",city:"lisbon",stops:[{order:0,cat:"sight",name:"ë¦¬ìŠ¤ë³¸ ëŒ€ì„±ë‹¹",nameEn:"SÃ© de Lisboa",lat:38.709834,lng:-9.132954,tm:"11:30",dur:"45ë¶„",note:"1147ë…„ ì„±ë‹¹."},{order:1,cat:"sight",name:"ìƒ ì¡°ë¥´ì œ ì„±",nameEn:"Castelo de SÃ£o Jorge",lat:38.713909,lng:-9.133476,tm:"12:30",dur:"90ë¶„",note:"íŒŒë…¸ë¼ë§ˆ!"},{order:2,cat:"food",name:"ğŸ½ï¸ Taberna Sal Grosso",nameEn:"Taberna Sal Grosso",lat:38.7136987,lng:-9.1244447,tm:"14:15",dur:"75ë¶„",note:"ë¬¸ì–´+ê³ êµ¬ë§ˆ!"},{order:3,cat:"food",name:"ğŸ½ï¸ A Nossa Casa",nameEn:"A Nossa Casa",lat:38.7118452,lng:-9.1449444,tm:"19:00",dur:"90ë¶„",note:"íƒ€ë¥´íƒ€ë¥´!"}]},
{day:5,title:"ë¦¬ìŠ¤ë³¸ Day 2",sub:"ë²¨ë ",city:"lisbon",stops:[{order:0,cat:"food",name:"ğŸ½ï¸ íŒŒìŠ¤í…Œì´ìŠ¤ ë“œ ë²¨ë ",nameEn:"PastÃ©is de BelÃ©m",lat:38.6975105,lng:-9.203228,tm:"09:00",dur:"45ë¶„",note:"ì—ê·¸íƒ€ë¥´íŠ¸!"},{order:1,cat:"sight",name:"ì œë¡œë‹ˆë¬´ìŠ¤ ìˆ˜ë„ì›",nameEn:"Mosteiro dos JerÃ³nimos",lat:38.6978909,lng:-9.206704,tm:"10:00",dur:"90ë¶„",note:"ì˜ˆì•½!"},{order:2,cat:"sight",name:"ë²¨ë  íƒ‘",nameEn:"Torre de BelÃ©m",lat:38.691584,lng:-9.215977,tm:"12:00",dur:"30ë¶„",note:"ê³µì‚¬ ì¤‘."},{order:3,cat:"food",name:"ğŸ½ï¸ Time Out Market",nameEn:"Time Out Market",lat:38.7070608,lng:-9.1456691,tm:"13:30",dur:"75ë¶„",note:"ë‹¤ì–‘í•œ ìŒì‹."},{order:4,cat:"sight",name:"ì½”ë©”ë¥´ì‹œìš° ê´‘ì¥",nameEn:"PraÃ§a do ComÃ©rcio",lat:38.7072828,lng:-9.136361,tm:"15:30",dur:"45ë¶„",note:"ì„ì–‘!"}]},
{day:6,title:"ë¦¬ìŠ¤ë³¸ Day 3",sub:"ì‹ íŠ¸ë¼",city:"sintra",stops:[{order:0,cat:"sight",name:"í˜ë‚˜ ê¶ì „",nameEn:"PalÃ¡cio da Pena",lat:38.7875851,lng:-9.3906089,tm:"10:00",dur:"150ë¶„",note:"ì˜ˆì•½!"}]},
{day:7,title:"ë¦¬ìŠ¤ë³¸ Day 4",sub:"ë°”ì´ìƒ¤",city:"lisbon",stops:[{order:0,cat:"sight",name:"ì¹´ë¥´ë¬´ ë°•ë¬¼ê´€",nameEn:"Museu do Carmo",lat:38.712038,lng:-9.140613,tm:"10:30",dur:"60ë¶„",note:"ì§€ë¶• ì—†ëŠ” ì„±ë‹¹!"},{order:1,cat:"food",name:"ğŸ½ï¸ Lisbon Tu e Eu",nameEn:"Lisboa Tu & Eu",lat:38.710951,lng:-9.130052,tm:"12:30",dur:"75ë¶„",note:"ê°€ì„±ë¹„."},{order:2,cat:"food",name:"ğŸ½ï¸ Cervejaria Ramiro",nameEn:"Cervejaria Ramiro",lat:38.720257,lng:-9.135743,tm:"19:00",dur:"90ë¶„",note:"í•´ì‚°ë¬¼!"}]},
{day:8,title:"ë¦¬ìŠ¤ë³¸ Day 5",sub:"í”¼ë‚ ë ˆ",city:"lisbon",stops:[{order:0,cat:"sight",name:"ì˜¤ì„¸ì•„ë‚˜ë¦¬ì›€",nameEn:"OceanÃ¡rio",lat:38.7635435,lng:-9.0937415,tm:"10:00",dur:"180ë¶„",note:"ìœ ëŸ½ ìµœëŒ€!"},{order:1,cat:"food",name:"ğŸ½ï¸ Augusto Lisboa",nameEn:"Augusto Lisboa",lat:38.714425,lng:-9.130207,tm:"14:30",dur:"75ë¶„",note:"ë¸ŒëŸ°ì¹˜!"},{order:2,cat:"food",name:"ğŸ½ï¸ Copo de Mar",nameEn:"Copo de Mar",lat:38.739801,lng:-9.149103,tm:"19:30",dur:"90ë¶„",note:"í”¼ë‚ ë ˆ!"}]}
];

// ===== LOCAL STORAGE HELPERS =====
function lsGet(key){try{return JSON.parse(localStorage.getItem(key));}catch(e){return null;}}
function lsSet(key,val){try{localStorage.setItem(key,JSON.stringify(val));localStorage.setItem(LS_LASTMOD,Date.now());}catch(e){console.warn('LS full');}}
function showStatus(msg,cls){var el=document.getElementById('syncStatus');el.textContent=msg;el.className='sync-status '+(cls||'');setTimeout(()=>{el.textContent='';},4000);}

// ===== INIT: Load from LocalStorage first, then render =====
var DATA_VER='v3'; // bump to force seed refresh (v3: added day field + cafes)
function initLocal(){
  var places=lsGet(LS_PLACES);
  var days=lsGet(LS_DAYS);
  var ver=localStorage.getItem('pt_ver');
  if(!places||!places.length||ver!==DATA_VER){places=SEED_PLACES;lsSet(LS_PLACES,places);localStorage.setItem('pt_ver',DATA_VER);}
  if(!days||!days.length||ver!==DATA_VER){days=SEED_ITIN;lsSet(LS_DAYS,days);}
  window._places=places;window._places.sort((a,b)=>(b.rating||0)-(a.rating||0));
  window._days=days;window._days.sort((a,b)=>a.day-b.day);
  window._days.forEach(d=>{if(d.stops)d.stops.sort((a,b)=>a.order-b.order);});
  window.renderDays();window.renderItinList();window.renderPlaces();window.updateItinMap();
  showStatus('ğŸ“± ì˜¤í”„ë¼ì¸ ëª¨ë“œ Â· ğŸ”„ ëˆŒëŸ¬ì„œ ë™ê¸°í™”','');
}

// ===== SYNC: Upload local â†’ Firebase, Download Firebase â†’ Local =====
window.syncData=async function(){
  var btn=document.getElementById('syncBtn');
  btn.classList.add('spinning');showStatus('â˜ï¸ ë™ê¸°í™” ì¤‘...','warn');
  try{
    // Ensure auth
    if(!auth.currentUser){
      showStatus('ğŸ” ë¡œê·¸ì¸ ì¤‘...','warn');
      await signInAnonymously(auth);
    }
    // 1. Upload local places to Firebase
    var localPlaces=lsGet(LS_PLACES)||[];
    var oldSnap=await getDocs(collection(db,PCOL));
    var deletes=[];oldSnap.forEach(d=>{deletes.push(deleteDoc(doc(db,PCOL,d.id)));});
    if(deletes.length)await Promise.all(deletes);
    for(const p of localPlaces){
      var pCopy={...p};delete pCopy.id;
      await addDoc(collection(db,PCOL),pCopy);
    }
    // 2. Upload local itinerary to Firebase
    var localDays=lsGet(LS_DAYS)||[];
    for(const d of localDays){
      var dCopy={...d};
      if(dCopy.stops)dCopy.stops=dCopy.stops.map(s=>{var c={...s};delete c._transit;return c;});
      await setDoc(doc(db,ICOL,'day'+d.day),dCopy);
    }
    // 3. Download Firebase â†’ Local (get server IDs + others' changes)
    var pSnap=await getDocs(collection(db,PCOL));
    var fbPlaces=[];pSnap.forEach(d=>{fbPlaces.push({id:d.id,...d.data()});});
    fbPlaces.sort((a,b)=>(b.rating||0)-(a.rating||0));
    var iSnap=await getDocs(collection(db,ICOL));
    var fbDays=[];iSnap.forEach(d=>{fbDays.push({id:d.id,...d.data()});});
    fbDays.sort((a,b)=>a.day-b.day);
    fbDays.forEach(d=>{if(d.stops)d.stops.sort((a,b)=>a.order-b.order);});
    // Save to local
    lsSet(LS_PLACES,fbPlaces);lsSet(LS_DAYS,fbDays);
    window._places=fbPlaces;window._days=fbDays;
    window.renderDays();window.renderItinList();window.renderPlaces();window.updateItinMap();
    var t=new Date();
    showStatus('âœ… ë™ê¸°í™” ì™„ë£Œ Â· '+t.getHours()+':'+String(t.getMinutes()).padStart(2,'0'),'ok');
  }catch(e){
    console.error('Sync error:',e);
    showStatus('âŒ ë™ê¸°í™” ì‹¤íŒ¨: '+(e.message||'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'),'err');
  }
  btn.classList.remove('spinning');
};

// ===== LOCAL CRUD =====
window.loadAll=function(){
  window._places=lsGet(LS_PLACES)||[];window._places.sort((a,b)=>(b.rating||0)-(a.rating||0));
  window._days=lsGet(LS_DAYS)||[];window._days.sort((a,b)=>a.day-b.day);
  window._days.forEach(d=>{if(d.stops)d.stops.sort((a,b)=>a.order-b.order);});
  window.renderDays();window.renderItinList();window.renderPlaces();window.updateItinMap();
};

window.saveDay=function(dayId,data){
  var days=lsGet(LS_DAYS)||[];
  var idx=days.findIndex(d=>d.id===dayId||'day'+d.day===dayId);
  if(idx>=0)days[idx]=data;
  lsSet(LS_DAYS,days);
};

window.savePlaces=function(){lsSet(LS_PLACES,window._places);};

initLocal();
</script>

<script>
// ===== STATE =====
var cur=0,sel=null,gmap,gmks=[],iw,dRenderer,dService,pmap,pmks=[],piw,pFilter='all';
var darkStyle=[{elementType:"geometry",stylers:[{color:"#1d2c3a"}]},{elementType:"labels.text.stroke",stylers:[{color:"#1a2636"}]},{elementType:"labels.text.fill",stylers:[{color:"#746855"}]},{featureType:"administrative.locality",elementType:"labels.text.fill",stylers:[{color:"#d59563"}]},{featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#d59563"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#1a3325"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#2a3f54"}]},{featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#9ca5b3"}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#3a5169"}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#2f4357"}]},{featureType:"transit.station",elementType:"labels.text.fill",stylers:[{color:"#d59563"}]},{featureType:"water",elementType:"geometry",stylers:[{color:"#0e1d2b"}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#515c6d"}]}];

// ===== MAIN TAB =====
window.mainTab=function(t){
  document.getElementById('itinPanel').classList.toggle('v',t==='itin');
  document.getElementById('placesPanel').classList.toggle('v',t==='places');
  document.getElementById('mt1').classList.toggle('on',t==='itin');
  document.getElementById('mt2').classList.toggle('on',t==='places');
  if(t==='itin'&&gmap)setTimeout(()=>google.maps.event.trigger(gmap,'resize'),100);
  if(t==='places'&&pmap)setTimeout(()=>google.maps.event.trigger(pmap,'resize'),100);
};

// ===== ITINERARY =====
window.renderDays=function(){
  var days=window._days||[];
  document.getElementById('dy').innerHTML=days.map((d,i)=>'<button class="db'+(i===cur?' on':'')+'" onclick="pickDay('+i+')">D'+d.day+' <span class="c">'+(d.city==='porto'?'í¬ë¥´íˆ¬':d.city==='lisbon'?'ë¦¬ìŠ¤ë³¸':'ì‹ íŠ¸ë¼')+'</span></button>').join('');
};

window.pickDay=function(i){cur=i;sel=null;closeMapCard();renderDays();renderItinList();updateItinMap();};

window.renderItinList=function(){
  var days=window._days||[];if(!days.length){document.getElementById('ls').innerHTML='<div class="empty">ì¼ì • ë¡œë”© ì¤‘...</div>';return;}
  var d=days[cur];if(!d)return;
  var stops=d.stops||[];
  var h='<div class="dh"><h2>'+d.title+' â€” '+d.sub+'</h2></div>';
  stops.forEach(function(x,i){
    // Transport info between stops
    if(i>0&&x._transit){
      h+='<div class="tl"><div class="tl-b"></div></div>';
      var mode=x._transit.mode||'walk';
      var icon=mode==='walk'?'ğŸš¶':mode==='transit'?'ğŸšŒ':'ğŸš—';
      h+='<div class="tp"><div class="ti '+mode+'">'+icon+'</div><div class="tt"><b>'+x._transit.text+'</b>'+(x._transit.detail?'<br>'+x._transit.detail:'')+'</div></div>';
      h+='<div class="tl"><div class="tl-b"></div></div>';
    }
    var ac=sel===i?' on':'';
    var catClass=x.cat||'sight';
    h+='<div class="st'+ac+'" onclick="pickStop('+i+')" id="s'+i+'">';
    h+='<div class="sn '+catClass+'">'+(i+1)+'</div>';
    h+='<div class="si"><div class="nm">'+x.name+'<br><span class="ne">'+(x.nameEn||'')+'</span></div>';
    h+='<div class="sm"><span class="tm">'+(x.tm||'')+'</span><span>'+(x.dur||'')+'</span></div>';
    if(x.note)h+='<div class="nt">'+x.note+'</div>';
    h+='<div class="st-actions">';
    if(i>0)h+='<button class="sa up" onclick="event.stopPropagation();moveStop('+i+',-1)">â†‘ ìœ„ë¡œ</button>';
    if(i<stops.length-1)h+='<button class="sa down" onclick="event.stopPropagation();moveStop('+i+',1)">â†“ ì•„ë˜</button>';
    h+='<button class="sa del" onclick="event.stopPropagation();removeStop('+i+')">ğŸ—‘ï¸ ì‚­ì œ</button>';
    h+='</div></div></div>';
  });
  h+='<button class="add-stop" onclick="openDayModal()">+ ì €ì¥ì†Œì—ì„œ ì¶”ê°€</button>';
  document.getElementById('ls').innerHTML=h;
};

window.pickStop=function(i){
  sel=sel===i?null:i;renderItinList();
  if(sel!==null){var x=(window._days[cur].stops||[])[sel];if(x&&x.lat){gmap.panTo({lat:x.lat,lng:x.lng});gmap.setZoom(16);if(gmks[sel])showIW(sel);}
    var el=document.getElementById('s'+sel);if(el)el.scrollIntoView({behavior:'smooth',block:'center'});}
};

window.moveStop=function(idx,dir){
  var d=window._days[cur];var stops=d.stops||[];
  var ni=idx+dir;if(ni<0||ni>=stops.length)return;
  var tmp=stops[idx];stops[idx]=stops[ni];stops[ni]=tmp;
  stops.forEach((s,i)=>s.order=i);
  window.saveDay(d.id||'day'+d.day,d);
  renderItinList();updateItinMap();calcTransits();
};

window.removeStop=function(idx){
  if(!confirm('ì¼ì •ì—ì„œ ì‚­ì œí•˜ì‹œê² ì–´ìš”?'))return;
  var d=window._days[cur];d.stops.splice(idx,1);
  d.stops.forEach((s,i)=>s.order=i);
  window.saveDay(d.id||'day'+d.day,d);sel=null;
  renderItinList();updateItinMap();calcTransits();
};

window.addStopToDay=function(dayIdx,place){
  var d=window._days[dayIdx];if(!d.stops)d.stops=[];
  d.stops.push({order:d.stops.length,cat:place.cat,name:place.name,nameEn:place.nameEn||'',lat:place.lat||0,lng:place.lng||0,tm:'',dur:'',note:place.tip||place.menu||''});
  window.saveDay(d.id||'day'+d.day,d);
  closeDayModal();
  cur=dayIdx;sel=null;
  mainTab('itin');renderDays();renderItinList();updateItinMap();
  setTimeout(calcTransits,500);
};

// ===== DIRECTIONS AUTO CALC =====
window.calcTransits=function(){
  var d=window._days[cur];var stops=d.stops||[];
  if(stops.length<2)return;
  for(var i=1;i<stops.length;i++){
    (function(idx){
      var a=stops[idx-1],b=stops[idx];
      if(!a.lat||!b.lat)return;
      dService.route({origin:{lat:a.lat,lng:a.lng},destination:{lat:b.lat,lng:b.lng},travelMode:google.maps.TravelMode.WALKING},function(r,s){
        if(s==='OK'){
          var leg=r.routes[0].legs[0];
          var mins=Math.round(leg.duration.value/60);
          var dist=leg.distance.text;
          stops[idx]._transit={mode:'walk',text:'ë„ë³´ '+mins+'ë¶„',detail:dist};
        }else{
          // Try transit
          dService.route({origin:{lat:a.lat,lng:a.lng},destination:{lat:b.lat,lng:b.lng},travelMode:google.maps.TravelMode.TRANSIT},function(r2,s2){
            if(s2==='OK'){
              var leg=r2.routes[0].legs[0];
              var mins=Math.round(leg.duration.value/60);
              stops[idx]._transit={mode:'transit',text:'ëŒ€ì¤‘êµí†µ '+mins+'ë¶„',detail:leg.distance.text};
            }else{
              stops[idx]._transit={mode:'walk',text:'ê²½ë¡œ ê³„ì‚° ë¶ˆê°€',detail:''};
            }
            renderItinList();
          });return;
        }
        renderItinList();
      });
    })(i);
  }
};

function showIW(idx){
  var stops=(window._days[cur].stops||[]);var x=stops[idx];if(!x)return;
  // Hide Google InfoWindow, show bottom card instead
  iw.close();
  var cc=x.cat==='food'?'#22c55e':x.cat==='cafe'?'#ec4899':x.cat==='lodge'?'#f59e0b':'#3b82f6';
  var icon=x.cat==='food'?'ğŸ½ï¸':x.cat==='cafe'?'â˜•':x.cat==='lodge'?'ğŸ¨':'ğŸ›ï¸';
  document.getElementById('mcNum').style.background=cc;
  document.getElementById('mcNum').textContent=idx+1;
  document.getElementById('mcName').textContent=x.name;
  document.getElementById('mcEn').textContent=x.nameEn||'';
  var meta='';
  if(x.tm)meta+='<span class="rt">'+x.tm+'</span>';
  if(x.dur)meta+='<span style="background:rgba(255,255,255,.05);color:var(--dm)">'+x.dur+'</span>';
  document.getElementById('mcMeta').innerHTML=meta;
  document.getElementById('mcNote').innerHTML=(x.note||'')+(x.tip?'<br>ğŸ’¡ '+x.tip:'');
  // Transit info
  var tEl=document.getElementById('mcTransit');
  if(x._transit){tEl.style.display='flex';tEl.innerHTML=(x._transit.mode==='walk'?'ğŸš¶':'ğŸšŒ')+' <b>'+x._transit.text+'</b> '+(x._transit.detail||'');}
  else if(idx===0){tEl.style.display='none';}
  else{tEl.style.display='flex';tEl.innerHTML='â³ ê²½ë¡œ ê³„ì‚° ì¤‘...';}
  document.getElementById('mapCard').classList.add('show');
  document.getElementById('mapLgd').style.display='none';
}

window.closeMapCard=function(){
  document.getElementById('mapCard').classList.remove('show');
  document.getElementById('mapLgd').style.display='flex';
  sel=null;
};

window.navCard=function(dir){
  var stops=(window._days[cur].stops||[]);
  var ni=(sel||0)+dir;
  if(ni<0)ni=stops.length-1;
  if(ni>=stops.length)ni=0;
  sel=ni;
  var x=stops[sel];
  if(x&&x.lat){gmap.panTo({lat:x.lat,lng:x.lng});gmap.setZoom(16);}
  showIW(sel);
};

window.updateItinMap=function(){
  if(!gmap)return;
  gmks.forEach(m=>m.setMap(null));gmks=[];dRenderer.setDirections({routes:[]});
  var days=window._days||[];var d=days[cur];if(!d)return;
  var stops=d.stops||[];var bounds=new google.maps.LatLngBounds();
  stops.forEach(function(x,i){
    if(!x.lat)return;var pos={lat:x.lat,lng:x.lng};bounds.extend(pos);
    var cc=x.cat==='food'?'#22c55e':x.cat==='cafe'?'#ec4899':x.cat==='lodge'?'#f59e0b':'#3b82f6';
    var mk=new google.maps.Marker({position:pos,map:gmap,label:{text:String(i+1),color:'#fff',fontSize:'12px',fontWeight:'700'},icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:cc,fillOpacity:1,strokeColor:'#fff',strokeWeight:2,scale:16,labelOrigin:new google.maps.Point(0,0)},zIndex:100+i});
    mk.addListener('click',function(){sel=i;gmap.panTo(pos);gmap.setZoom(16);showIW(i);});gmks.push(mk);
  });
  if(stops.length>0)gmap.fitBounds(bounds,60);
  // Draw route
  if(stops.length>=2){
    var pts=stops.filter(s=>s.lat);
    if(pts.length>=2){
      var o={lat:pts[0].lat,lng:pts[0].lng},de={lat:pts[pts.length-1].lat,lng:pts[pts.length-1].lng};
      var wps=[];for(var i=1;i<pts.length-1;i++)wps.push({location:{lat:pts[i].lat,lng:pts[i].lng},stopover:true});
      dService.route({origin:o,destination:de,waypoints:wps,travelMode:google.maps.TravelMode.WALKING},function(r,s){if(s==='OK')dRenderer.setDirections(r);});
    }
  }
  calcTransits();
};

window.itinView=function(v){
  var mw=document.getElementById('mw'),lw=document.getElementById('lw');
  document.getElementById('iv1').classList.toggle('on',v==='map');
  document.getElementById('iv2').classList.toggle('on',v==='list');
  mw.classList.toggle('v',v==='map');lw.classList.toggle('v',v==='list');
  closeMapCard();
  if(v==='map'){
    setTimeout(function(){google.maps.event.trigger(gmap,'resize');},50);
    setTimeout(function(){google.maps.event.trigger(gmap,'resize');updateItinMap();},200);
    setTimeout(function(){google.maps.event.trigger(gmap,'resize');},500);
  }
};

// ===== PLACES =====
function catIcon(c){return c==='food'?'ğŸ½ï¸':c==='cafe'?'â˜•':c==='lodge'?'ğŸ¨':'ğŸ›ï¸';}
function catColor(c){return c==='food'?'#22c55e':c==='cafe'?'#ec4899':c==='lodge'?'#f59e0b':'#3b82f6';}
function cityName(c){return c==='porto'?'í¬ë¥´íˆ¬':c==='lisbon'?'ë¦¬ìŠ¤ë³¸':'ì‹ íŠ¸ë¼';}

var pSort='rating'; // 'rating' or 'day'
window.toggleSort=function(){
  pSort=pSort==='rating'?'day':'rating';
  document.getElementById('sortBtn').classList.toggle('on',pSort==='day');
  document.getElementById('sortBtn').textContent=pSort==='day'?'â­ í‰ì ìˆœ':'ğŸ“… ì¼ì°¨ìˆœ';
  renderPlaces();
};

window.renderPlaces=function(){
  var list=window._places||[];var f=pFilter;
  if(f==='food'||f==='cafe'||f==='sight'||f==='lodge')list=list.filter(p=>p.cat===f);
  else if(f==='porto'||f==='lisbon')list=list.filter(p=>p.city===f);
  else if(f==='visited')list=list.filter(p=>p.visited);
  else if(f==='noday')list=list.filter(p=>!p.day);
  else if(f&&f.startsWith('d')){var dn=parseInt(f.substring(1));list=list.filter(p=>p.day===dn);}
  // Sort
  if(pSort==='day')list=list.slice().sort((a,b)=>(a.day||99)-(b.day||99)||(b.rating||0)-(a.rating||0));
  else list=list.slice().sort((a,b)=>(b.rating||0)-(a.rating||0));
  if(!list.length){document.getElementById('plist').innerHTML='<div class="empty">ì¥ì†Œê°€ ì—†ì–´ìš”<br>+ ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€!</div>';updatePmap([]);return;}
  var h='',lastDay=-1;
  list.forEach(function(p){
    // Day divider in day-sort mode
    if(pSort==='day'&&(p.day||0)!==lastDay){
      lastDay=p.day||0;
      h+='<div style="padding:8px 4px 4px;font-size:12px;font-weight:700;color:var(--acc)">'+(lastDay?'Day '+lastDay:'ğŸ“Œ ë¯¸ì •')+'</div>';
    }
    var dayBadge=p.day?'<span class="day-badge set" onclick="event.stopPropagation();openDaySet(\''+p.id+'\','+p.day+')">D'+p.day+'</span>':'<span class="day-badge unset" onclick="event.stopPropagation();openDaySet(\''+p.id+'\',0)">?</span>';
    h+='<div class="pcard'+(p.visited?' visited':'')+'"><div class="pcard-top"><div class="pcard-icon '+p.cat+'">'+catIcon(p.cat)+'</div><div class="pcard-info"><div class="pcard-name">'+dayBadge+' '+p.name+'</div><div class="pcard-en">'+(p.nameEn||'')+'</div><div class="pcard-meta">';
    if(p.rating)h+='<span class="rt">â˜… '+p.rating+'</span>';if(p.price)h+='<span class="pr">'+p.price+'</span>';
    h+='<span style="background:rgba(255,255,255,.05);color:var(--dm)">'+cityName(p.city)+'</span>';
    if(p.closed)h+='<span class="cl">íœ´ë¬´ '+p.closed+'</span>';
    h+='</div></div></div><div class="pcard-detail">';
    if(p.menu)h+='<div>ğŸ´ '+p.menu+'</div>';if(p.hours)h+='<div>ğŸ• '+p.hours+'</div>';if(p.tip)h+='<div>ğŸ’¡ '+p.tip+'</div>';
    h+='</div><div class="pcard-actions">';
    h+='<button class="pact visit'+(p.visited?' done':'')+'" onclick="toggleVisit(\''+p.id+'\','+p.visited+')">'+(p.visited?'âœ… ì™„ë£Œ':'â˜ ì²´í¬')+'</button>';
    h+='<button class="pact additin" onclick="openDayPicker(\''+p.id+'\')">ğŸ“… ì¼ì •ì¶”ê°€</button>';
    if(p.lat&&p.lng)h+='<button class="pact mapbtn" onclick="focusPmap('+p.lat+','+p.lng+')">ğŸ“</button>';
    h+='<button class="pact" style="background:rgba(232,168,56,.1);color:var(--acc)" onclick="editPlace(\''+p.id+'\')">âœï¸</button>';
    h+='<button class="pact del" onclick="deletePlace(\''+p.id+'\')">ğŸ—‘ï¸</button>';
    h+='</div></div>';
  });
  document.getElementById('plist').innerHTML=h;updatePmap(list);
};

window.pf=function(f,el){
  pFilter=f;
  // Handle both filter rows
  document.querySelectorAll('#pbar .pbtn, #pbar2 .pbtn:not(#sortBtn)').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');
  if(f==='all')document.querySelector('#pbar .pbtn').classList.add('on');
  renderPlaces();
};

// Day assignment for places (tap the day badge)
window.openDaySet=function(id,curDay){
  var nums=[1,2,3,4,5,6,7,8];
  var h='<div style="font-size:13px;font-weight:600;margin-bottom:8px">ğŸ“… ëª‡ì¼ì°¨?</div><div class="day-pick-row">';
  nums.forEach(function(n){
    h+='<button class="'+(n===curDay?'active':'')+'" onclick="setPlaceDay(\''+id+'\','+n+')">'+n+'</button>';
  });
  h+='<button style="width:auto;padding:0 10px" onclick="setPlaceDay(\''+id+'\',0)">âœ•</button></div>';
  // Find the card and insert picker
  var cards=document.querySelectorAll('.pcard');
  var places=window._places||[];
  var idx=places.findIndex(p=>p.id===id);
  if(idx>=0&&cards.length){
    // Find correct card in filtered list
    var filtered=getFilteredList();
    var fi=filtered.findIndex(p=>p.id===id);
    if(fi>=0&&cards[fi]){
      var existing=cards[fi].querySelector('.day-pick-row');
      if(existing){existing.parentElement.remove();return;} // toggle off
      var div=document.createElement('div');
      div.style.cssText='padding:6px 0';div.innerHTML=h;
      cards[fi].querySelector('.pcard-actions').before(div);
    }
  }
};

function getFilteredList(){
  var list=window._places||[];var f=pFilter;
  if(f==='food'||f==='cafe'||f==='sight'||f==='lodge')list=list.filter(p=>p.cat===f);
  else if(f==='porto'||f==='lisbon')list=list.filter(p=>p.city===f);
  else if(f==='visited')list=list.filter(p=>p.visited);
  else if(f==='noday')list=list.filter(p=>!p.day);
  else if(f&&f.startsWith('d')){var dn=parseInt(f.substring(1));list=list.filter(p=>p.day===dn);}
  if(pSort==='day')list=list.slice().sort((a,b)=>(a.day||99)-(b.day||99)||(b.rating||0)-(a.rating||0));
  else list=list.slice().sort((a,b)=>(b.rating||0)-(a.rating||0));
  return list;
}

window.setPlaceDay=function(id,day){
  var places=window._places||[];
  var p=places.find(x=>x.id===id);
  if(p){p.day=day||0;}
  savePlaces();renderPlaces();
};

window.placeView=function(m){
  document.getElementById('pv1').classList.toggle('on',m==='list');
  document.getElementById('pv2').classList.toggle('on',m==='map');
  document.querySelector('.plist').style.display=m==='list'?'block':'none';
  document.getElementById('pmap').style.display=m==='map'?'block':'none';
  if(m==='map'&&pmap)google.maps.event.trigger(pmap,'resize');
};

function updatePmap(list){
  if(!pmap)return;pmks.forEach(m=>m.setMap(null));pmks=[];if(!piw)piw=new google.maps.InfoWindow();
  var bounds=new google.maps.LatLngBounds();
  list.forEach(function(p){if(!p.lat||!p.lng)return;bounds.extend({lat:p.lat,lng:p.lng});
    var mk=new google.maps.Marker({position:{lat:p.lat,lng:p.lng},map:pmap,icon:{path:google.maps.SymbolPath.CIRCLE,fillColor:catColor(p.cat),fillOpacity:1,strokeColor:'#fff',strokeWeight:2,scale:12},title:p.name});
    mk.addListener('click',function(){piw.setContent('<div class="iw"><h3>'+catIcon(p.cat)+' '+p.name+'</h3>'+(p.rating?'<p>â˜… '+p.rating+'</p>':'')+(p.menu?'<p>ğŸ´ '+p.menu+'</p>':'')+'</div>');piw.open(pmap,mk);});pmks.push(mk);
  });if(list.length>0)pmap.fitBounds(bounds,50);
}

window.focusPmap=function(lat,lng){mainTab('places');placeView('map');setTimeout(()=>{pmap.panTo({lat,lng});pmap.setZoom(16);},200);};

// ===== PLACE CRUD =====
window.openAdd=function(){
  document.getElementById('modalTitle').textContent='ìƒˆ ì¥ì†Œ ì¶”ê°€';
  document.getElementById('modal').dataset.editId='';
  ['fName','fNameEn','fRating','fHours','fClosed','fMenu','fTip','fLat','fLng'].forEach(id=>{document.getElementById(id).value='';});
  document.getElementById('fCat').selectedIndex=0;document.getElementById('fCity').selectedIndex=0;document.getElementById('fPrice').selectedIndex=0;
  document.getElementById('acHint').innerHTML='ğŸ“ ê²€ìƒ‰ í›„ ì„ íƒí•˜ë©´ ì¢Œí‘œÂ·í‰ì Â·ì¹´í…Œê³ ë¦¬ ìë™ ì…ë ¥';
  document.getElementById('acHint').style.color='var(--acc)';
  document.getElementById('modal').classList.add('v');
};
window.closeModal=function(){document.getElementById('modal').classList.remove('v');};

window.savePlace=function(){
  var d={cat:document.getElementById('fCat').value,city:document.getElementById('fCity').value,name:document.getElementById('fName').value.trim(),nameEn:document.getElementById('fNameEn').value.trim(),rating:parseFloat(document.getElementById('fRating').value)||0,price:document.getElementById('fPrice').value,hours:document.getElementById('fHours').value.trim(),closed:document.getElementById('fClosed').value.trim(),menu:document.getElementById('fMenu').value.trim(),tip:document.getElementById('fTip').value.trim(),lat:parseFloat(document.getElementById('fLat').value)||0,lng:parseFloat(document.getElementById('fLng').value)||0,visited:false,createdAt:Date.now()};
  if(!d.name){alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  var eid=document.getElementById('modal').dataset.editId;
  if(eid){var idx=window._places.findIndex(x=>x.id===eid);if(idx>=0){d.id=eid;d.visited=window._places[idx].visited;d.day=window._places[idx].day||0;window._places[idx]=d;}}
  else{d.id='p'+Date.now();d.day=0;window._places.push(d);}
  savePlaces();closeModal();loadAll();
};

window.deletePlace=function(id){if(!confirm('ì‚­ì œ?'))return;window._places=window._places.filter(x=>x.id!==id);savePlaces();loadAll();};
window.toggleVisit=function(id,cur){var p=window._places.find(x=>x.id===id);if(p){p.visited=!cur;savePlaces();loadAll();}};
window.editPlace=function(id){
  var p=(window._places||[]).find(x=>x.id===id);if(!p)return;
  document.getElementById('modalTitle').textContent='ì¥ì†Œ ìˆ˜ì •';document.getElementById('modal').dataset.editId=id;
  document.getElementById('fCat').value=p.cat||'food';document.getElementById('fCity').value=p.city||'porto';
  document.getElementById('fName').value=p.name||'';document.getElementById('fNameEn').value=p.nameEn||'';
  document.getElementById('fRating').value=p.rating||'';document.getElementById('fPrice').value=p.price||'';
  document.getElementById('fHours').value=p.hours||'';document.getElementById('fClosed').value=p.closed||'';
  document.getElementById('fMenu').value=p.menu||'';document.getElementById('fTip').value=p.tip||'';
  document.getElementById('fLat').value=p.lat||'';document.getElementById('fLng').value=p.lng||'';
  document.getElementById('modal').classList.add('v');
};

// ===== DAY PICKER =====
window._pendingPlace=null;
window.openDayPicker=function(placeId){
  window._pendingPlace=(window._places||[]).find(x=>x.id===placeId);
  var days=window._days||[];
  document.getElementById('dayPick').innerHTML=days.map((d,i)=>'<button onclick="addStopToDay('+i+',window._pendingPlace)">D'+d.day+' '+d.sub+'</button>').join('');
  document.getElementById('dayModal').classList.add('v');
};
window.openDayModal=function(){
  // Show places to pick from
  var places=window._places||[];
  var h=places.map(p=>'<button onclick="addStopToDay('+cur+',{cat:\''+p.cat+'\',name:\''+p.name.replace(/'/g,"\\'")+'\',nameEn:\''+(p.nameEn||'').replace(/'/g,"\\'")+'\',lat:'+p.lat+',lng:'+p.lng+',tip:\''+(p.tip||'').replace(/'/g,"\\'")+'\',menu:\''+(p.menu||'').replace(/'/g,"\\'")+'\'})">'+(p.cat==='food'?'ğŸ½ï¸':p.cat==='cafe'?'â˜•':'ğŸ›ï¸')+' '+p.name+'</button>').join('');
  document.getElementById('dayPick').innerHTML=h;
  document.getElementById('dayModal').querySelector('h2').textContent='ì¶”ê°€í•  ì¥ì†Œë¥¼ ì„ íƒí•˜ì„¸ìš”';
  document.getElementById('dayModal').classList.add('v');
};
window.closeDayModal=function(){document.getElementById('dayModal').classList.remove('v');};

// ===== EXPORT: Google Maps URL =====
window.openExport=function(){
  document.getElementById('expDay').textContent=(cur+1);
  var places=window._places||[];
  var counts={food:0,cafe:0,sight:0,lodge:0};
  places.forEach(function(p){if(counts[p.cat]!==undefined)counts[p.cat]++;});
  document.getElementById('expFood').textContent=counts.food?'('+counts.food+'ê°œ)':'(ì—†ìŒ)';
  document.getElementById('expCafe').textContent=counts.cafe?'('+counts.cafe+'ê°œ)':'(ì—†ìŒ)';
  document.getElementById('expSight').textContent=counts.sight?'('+counts.sight+'ê°œ)':'(ì—†ìŒ)';
  document.getElementById('expLodge').textContent=counts.lodge?'('+counts.lodge+'ê°œ)':'(ì—†ìŒ)';
  document.getElementById('exportModal').classList.add('v');
};
window.closeExport=function(){document.getElementById('exportModal').classList.remove('v');};

window.openInGmaps=function(mode){
  var items=[];
  if(mode==='day'){
    var d=(window._days||[])[cur];
    if(!d||!d.stops||!d.stops.length){alert('ì¼ì •ì´ ì—†ì–´ìš”');return;}
    items=d.stops.filter(function(s){return s.lat&&s.lng;});
  }else{
    // Category filter: food, cafe, sight, lodge
    items=(window._places||[]).filter(function(p){return p.cat===mode&&p.lat&&p.lng;});
  }
  if(!items.length){alert('ì¥ì†Œê°€ ì—†ì–´ìš”');return;}

  if(mode==='day'&&items.length>=2){
    // Walking directions for itinerary
    var origin=items[0].lat+','+items[0].lng;
    var dest=items[items.length-1].lat+','+items[items.length-1].lng;
    var wps=items.slice(1,-1).map(function(s){return s.lat+','+s.lng;}).join('|');
    var url='https://www.google.com/maps/dir/?api=1&origin='+origin+'&destination='+dest;
    if(wps)url+='&waypoints='+encodeURIComponent(wps);
    url+='&travelmode=walking';
    window.open(url,'_blank');
  }else if(items.length===1){
    window.open('https://www.google.com/maps/search/?api=1&query='+items[0].lat+','+items[0].lng,'_blank');
  }else{
    // Directions to show pins (max ~10)
    var limited=items.slice(0,10);
    var origin=limited[0].lat+','+limited[0].lng;
    var dest=limited[limited.length-1].lat+','+limited[limited.length-1].lng;
    var wps=limited.slice(1,-1).map(function(s){return s.lat+','+s.lng;}).join('|');
    var url='https://www.google.com/maps/dir/?api=1&origin='+origin+'&destination='+dest;
    if(wps)url+='&waypoints='+encodeURIComponent(wps);
    window.open(url,'_blank');
  }
  closeExport();
};

// ===== INIT MAP =====
function initMap(){
  gmap=new google.maps.Map(document.getElementById('map'),{center:{lat:41.145,lng:-8.612},zoom:14,styles:darkStyle,disableDefaultUI:true,zoomControl:true,fullscreenControl:true});
  gmap.addListener('click',function(){closeMapCard();});
  iw=new google.maps.InfoWindow();
  dService=new google.maps.DirectionsService();
  dRenderer=new google.maps.DirectionsRenderer({suppressMarkers:true,polylineOptions:{strokeColor:'#e8a838',strokeWeight:4,strokeOpacity:0.8}});
  dRenderer.setMap(gmap);
  pmap=new google.maps.Map(document.getElementById('pmap'),{center:{lat:39.5,lng:-8.5},zoom:7,styles:darkStyle,disableDefaultUI:true,zoomControl:true,fullscreenControl:true});

  // Places Autocomplete
  var acInput=document.getElementById('fNameEn');
  var ac=new google.maps.places.Autocomplete(acInput,{
    types:['establishment'],
    fields:['name','formatted_address','geometry','rating','types','place_id','opening_hours','price_level'],
    componentRestrictions:{country:'pt'}
  });
  // Fix mobile: move pac-container into modal and fix touch events
  setTimeout(function(){
    var pac=document.querySelector('.pac-container');
    if(pac){
      document.getElementById('modal').querySelector('.modal').appendChild(pac);
    }
  },1000);
  // Also fix: prevent modal scroll from interfering
  acInput.addEventListener('focus',function(){
    setTimeout(function(){
      var pac=document.querySelector('.pac-container');
      if(pac&&!pac.closest('.modal')){
        document.getElementById('modal').querySelector('.modal').appendChild(pac);
      }
    },300);
  });
  // Global fix: make pac-items tappable on mobile Safari
  document.addEventListener('touchstart',function(e){
    if(e.target.closest('.pac-item')){
      e.target.closest('.pac-item').click();
    }
  },{passive:true});
  ac.addListener('place_changed',function(){
    var place=ac.getPlace();
    if(!place||!place.geometry)return;
    // Fill English name
    document.getElementById('fNameEn').value=place.name||'';
    // Fill coordinates
    document.getElementById('fLat').value=place.geometry.location.lat().toFixed(7);
    document.getElementById('fLng').value=place.geometry.location.lng().toFixed(7);
    // Fill rating
    if(place.rating)document.getElementById('fRating').value=place.rating;
    // Auto-detect city from address
    var addr=(place.formatted_address||'').toLowerCase();
    if(addr.indexOf('porto')>=0||addr.indexOf('gaia')>=0)document.getElementById('fCity').value='porto';
    else if(addr.indexOf('sintra')>=0)document.getElementById('fCity').value='sintra';
    else if(addr.indexOf('lisbon')>=0||addr.indexOf('lisboa')>=0)document.getElementById('fCity').value='lisbon';
    // Auto-detect category from types
    var types=(place.types||[]).join(',');
    if(types.indexOf('restaurant')>=0||types.indexOf('food')>=0||types.indexOf('meal')>=0||types.indexOf('bakery')>=0)document.getElementById('fCat').value='food';
    else if(types.indexOf('cafe')>=0)document.getElementById('fCat').value='cafe';
    else if(types.indexOf('lodging')>=0||types.indexOf('hotel')>=0)document.getElementById('fCat').value='lodge';
    else if(types.indexOf('tourist')>=0||types.indexOf('museum')>=0||types.indexOf('church')>=0||types.indexOf('park')>=0)document.getElementById('fCat').value='sight';
    // Auto-fill price level
    if(place.price_level!==undefined&&place.price_level!==null){
      var priceMap={0:'â‚¬',1:'â‚¬',2:'â‚¬â‚¬',3:'â‚¬â‚¬â‚¬',4:'â‚¬â‚¬â‚¬'};
      var pv=priceMap[place.price_level]||'';
      var sel=document.getElementById('fPrice');
      for(var i=0;i<sel.options.length;i++){if(sel.options[i].value===pv){sel.selectedIndex=i;break;}}
    }
    // Auto-fill opening hours
    if(place.opening_hours){
      var wh=place.opening_hours.weekday_text||[];
      var dayMap={'Monday':'ì›”','Tuesday':'í™”','Wednesday':'ìˆ˜','Thursday':'ëª©','Friday':'ê¸ˆ','Saturday':'í† ','Sunday':'ì¼'};
      var closedDays=[];var openTimes=[];
      wh.forEach(function(line){
        var parts=line.split(': ');if(parts.length<2)return;
        var dayEn=parts[0].trim();var timeStr=parts[1].trim();
        var dayKr=dayMap[dayEn]||dayEn;
        if(timeStr==='Closed'||timeStr==='íœ´ë¬´'){closedDays.push(dayKr);}
        else{
          var clean=timeStr.replace(/\u202f|\u2009|â€“/g,function(m){return m==='â€“'?'~':''}).replace(/\s*(AM|PM)/gi,function(m,p){return p.toUpperCase();});
          if(openTimes.indexOf(clean)<0)openTimes.push(clean);
        }
      });
      if(closedDays.length)document.getElementById('fClosed').value=closedDays.join(',');
      if(openTimes.length===1)document.getElementById('fHours').value=openTimes[0];
      else if(openTimes.length>1)document.getElementById('fHours').value=openTimes[0];
    }
    // Show confirmation
    document.getElementById('acHint').innerHTML='âœ… <b>'+place.name+'</b> ì„ íƒë¨ â€” ì¢Œí‘œÂ·í‰ì Â·ì˜ì—…ì‹œê°„ ìë™ ì…ë ¥';
    document.getElementById('acHint').style.color='var(--gn)';
  });
}
window.initMap=initMap;
</script>
<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD5Zq_g4MZmeTHi0hPIbQ5fp8-4P_nVVAY&libraries=places&callback=initMap"></script>
</body>
</html>
